name: Issue and Discussion Management

on:
  issues:
    types: [opened, labeled]
  discussion:
    types: [created]

jobs:
  auto-label-and-respond:
    runs-on: ubuntu-latest
    steps:
      - name: Auto-label new issues
        if: github.event.action == 'opened' && github.event.issue
        uses: github/issue-labeler@v3.0
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          configuration-path: .github/labeler.yml
          
      - name: Welcome new contributors
        if: github.event.action == 'opened' && github.event.issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const isFirstIssue = issue.author_association === 'FIRST_TIME_CONTRIBUTOR';
            
            if (isFirstIssue) {
              const welcomeMessage = `
              ğŸ‰ æ„Ÿè°¢æ‚¨çš„ç¬¬ä¸€æ¬¡è´¡çŒ®ï¼Welcome to your first contribution!
              
              æˆ‘ä»¬å¾ˆé«˜å…´æ”¶åˆ°æ‚¨çš„åé¦ˆã€‚è¯·ç»™æˆ‘ä»¬ä¸€äº›æ—¶é—´æ¥å®¡æŸ¥æ‚¨çš„æäº¤ã€‚
              We're excited to receive your feedback. Please give us some time to review your submission.
              
              åœ¨ç­‰å¾…æœŸé—´ï¼Œæ‚¨å¯ä»¥ï¼š
              While waiting, you can:
              - ğŸ“š æŸ¥çœ‹æˆ‘ä»¬çš„[è´¡çŒ®æŒ‡å—](https://github.com/zmofei/mofei-dev-tools/blob/main/CONTRIBUTING.md)
              - ğŸ’¬ åœ¨[è®¨è®ºåŒº](https://github.com/zmofei/mofei-dev-tools/discussions)ä¸ç¤¾åŒºäº¤æµ
              - ğŸ” æŸ¥çœ‹å…¶ä»–[å¼€æ”¾çš„Issues](https://github.com/zmofei/mofei-dev-tools/issues)
              
              Thank you for helping us improve Mofei Dev Tools! ğŸš€
              `;
              
              github.rest.issues.createComment({
                issue_number: issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: welcomeMessage
              });
            }
            
      - name: Auto-assign priority labels
        if: github.event.action == 'opened' && github.event.issue
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body.toLowerCase();
            
            // Auto-assign priority based on keywords
            let priority = 'priority-medium'; // default
            
            if (title.includes('critical') || title.includes('urgent') || 
                body.includes('critical') || body.includes('urgent') ||
                title.includes('ä¸¥é‡') || title.includes('ç´§æ€¥') ||
                body.includes('ä¸¥é‡') || body.includes('ç´§æ€¥')) {
              priority = 'priority-high';
            } else if (title.includes('minor') || title.includes('suggestion') ||
                      body.includes('minor') || body.includes('suggestion') ||
                      title.includes('å»ºè®®') || title.includes('å¯æœ‰å¯æ— ') ||
                      body.includes('å»ºè®®') || body.includes('å¯æœ‰å¯æ— ')) {
              priority = 'priority-low';
            }
            
            // Add priority label
            github.rest.issues.addLabels({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [priority]
            });
            
      - name: Notify team for high priority issues
        if: github.event.action == 'labeled' && contains(github.event.label.name, 'priority-high')
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const notificationMessage = `
            ğŸš¨ **é«˜ä¼˜å…ˆçº§é—®é¢˜é€šçŸ¥ | High Priority Issue Alert**
            
            æœ‰ä¸€ä¸ªé«˜ä¼˜å…ˆçº§çš„é—®é¢˜éœ€è¦å…³æ³¨ï¼š
            A high priority issue requires attention:
            
            **é—®é¢˜ | Issue**: ${issue.title}
            **é“¾æ¥ | Link**: ${issue.html_url}
            **æäº¤è€… | Reporter**: @${issue.user.login}
            
            è¯·å°½å¿«å¤„ç†æ­¤é—®é¢˜ã€‚
            Please address this issue as soon as possible.
            `;
            
            github.rest.issues.createComment({
              issue_number: issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: notificationMessage
            });
            
  discussion-response:
    runs-on: ubuntu-latest
    if: github.event.discussion
    steps:
      - name: Welcome discussion creators
        uses: actions/github-script@v7
        with:
          script: |
            const discussion = context.payload.discussion;
            const category = discussion.category.name;
            
            let welcomeMessage = `
            ğŸ‰ æ„Ÿè°¢æ‚¨å¼€å§‹è¿™ä¸ªè®¨è®ºï¼Thank you for starting this discussion!
            
            `;
            
            if (category === 'Ideas') {
              welcomeMessage += `
              ğŸ’¡ æˆ‘ä»¬å¾ˆå…´å¥‹å¬åˆ°æ‚¨çš„åˆ›æ„æƒ³æ³•ï¼æ‚¨çš„å»ºè®®å°†å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´å¥½çš„å·¥å…·ã€‚
              We're excited to hear your creative ideas! Your suggestions will help us build better tools.
              
              æ¥ä¸‹æ¥çš„æ­¥éª¤ï¼š
              Next steps:
              1. ç¤¾åŒºæˆå‘˜å¯èƒ½ä¼šå‚ä¸è®¨è®ºå¹¶æä¾›åé¦ˆ
              2. å¦‚æœæƒ³æ³•å¾—åˆ°è¶³å¤Ÿæ”¯æŒï¼Œæˆ‘ä»¬ä¼šè€ƒè™‘å®ç°
              3. æ‚¨å¯ä»¥æä¾›æ›´å¤šè¯¦ç»†ä¿¡æ¯æ¥å¸®åŠ©æˆ‘ä»¬ç†è§£éœ€æ±‚
              
              1. Community members may join the discussion and provide feedback
              2. If the idea gets enough support, we'll consider implementing it
              3. You can provide more details to help us understand the requirements
              `;
            } else if (category === 'Q&A') {
              welcomeMessage += `
              ğŸ¤” æ„Ÿè°¢æ‚¨çš„é—®é¢˜ï¼æˆ‘ä»¬ä¼šå°½å¿«å›å¤ã€‚
              Thank you for your question! We'll respond as soon as possible.
              
              åŒæ—¶ï¼Œæ‚¨ä¹Ÿå¯ä»¥ï¼š
              In the meantime, you can also:
              - ğŸ“š æŸ¥çœ‹[é¡¹ç›®æ–‡æ¡£](https://github.com/zmofei/mofei-dev-tools#readme)
              - ğŸ” æœç´¢[å·²æœ‰è®¨è®º](https://github.com/zmofei/mofei-dev-tools/discussions)çœ‹æ˜¯å¦æœ‰ç±»ä¼¼é—®é¢˜
              `;
            }
            
            // Note: GitHub API for discussions is still in beta
            // This is a placeholder for when the API becomes stable
            console.log('Discussion welcome message:', welcomeMessage);
            
  monthly-summary:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - name: Generate monthly feedback summary
        uses: actions/github-script@v7
        with:
          script: |
            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            
            // Get issues from last month
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              since: lastMonth.toISOString(),
              state: 'all'
            });
            
            const bugReports = issues.data.filter(issue => 
              issue.labels.some(label => label.name === 'bug')
            ).length;
            
            const featureRequests = issues.data.filter(issue => 
              issue.labels.some(label => label.name === 'enhancement')
            ).length;
            
            const summary = `
            # ğŸ“Š Monthly Feedback Summary - ${now.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long' })}
            
            ## ç»Ÿè®¡æ•°æ® | Statistics
            - ğŸ› Bug æŠ¥å‘Š | Bug Reports: ${bugReports}
            - âœ¨ åŠŸèƒ½è¯·æ±‚ | Feature Requests: ${featureRequests}
            - ğŸ“ æ€»Issues | Total Issues: ${issues.data.length}
            
            ## æœ€æ´»è·ƒçš„è´¡çŒ®è€… | Most Active Contributors
            ${issues.data.slice(0, 5).map(issue => `- @${issue.user.login}`).join('\n')}
            
            æ„Ÿè°¢æ‰€æœ‰å‚ä¸çš„ç”¨æˆ·ï¼| Thank you to all participants!
            `;
            
            console.log('Monthly summary:', summary);
            // Can be extended to post to discussions or create an issue